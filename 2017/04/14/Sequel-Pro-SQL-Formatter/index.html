<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Sequel Pro 实现更好的 SQL 格式化 · NewtonIO</title><meta name="description" content="Sequel Pro 实现更好的 SQL 格式化 - Newton"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://newton.sh/atom.xml" title="NewtonIO"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">存档</a></li><li class="nav-list-item"><a href="https://github.com/newt0n" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://instagram.com/newtonjin" target="_blank" class="nav-list-link">INSTAGRAM</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Sequel Pro 实现更好的 SQL 格式化</h1><div class="post-tags"><a href="/tags/SQL/" class="tag-title">#SQL</a><a href="/tags/Mac/" class="tag-title">#Mac</a></div><div class="post-info">Apr 14, 2017</div><div class="post-content"><p>让 Mac 上的数据库管理客户端 Sequel Pro 有更好的 SQL 格式化功能。<br><a id="more"></a></p>
<p>说起 Mac 上的数据库管理 App，靠谱的可选项并不多，除了 Win 平台同样有的老牌全功能客户端 Navicat，仅有 Sequel Pro、SQLPro Studio 等几个轻量的选择以及官方的 Workbench 和发布不久的 DataGrip。</p>
<p>在工具的选择上一向偏爱简洁够用就好，最初用 Mac 时反复比较了多个可选项最终选择了开源的 Sequel Pro 作为首选客户端，和之前在 Win 上主要用的 SQLyog 相比，界面操作之类的都可以习惯，唯独 SQL 格式化功能始终不能忍受。</p>
<h2 id="自带格式化功能入口"><a href="#自带格式化功能入口" class="headerlink" title="自带格式化功能入口"></a>自带格式化功能入口</h2><p>Sequel Pro 的 SQL 格式化功能以 Bundle 也就是插件的形式提供，使用菜单 <code>Bundles-&gt;Input Field-&gt;Format-&gt;Format SQL</code> 执行。</p>
<img src="/2017/04/14/Sequel-Pro-SQL-Formatter/14925125535553.jpg" alt="14925125535553.jpg" title="">
<h2 id="修正自带-Bundle"><a href="#修正自带-Bundle" class="headerlink" title="修正自带 Bundle"></a>修正自带 Bundle</h2><p>官方版本自带的 Bundle 很可能无法开箱即用：</p>
<img src="/2017/04/14/Sequel-Pro-SQL-Formatter/14925128749849.png" alt="14925128749849.png" title="">
<p>可以根据这个 Issue (<a href="https://github.com/sequelpro/sequelpro/issues/1988#issuecomment-60658598" target="_blank" rel="external">https://github.com/sequelpro/sequelpro/issues/1988#issuecomment-60658598</a>) 下的评论修正：</p>
<ul>
<li>打开菜单 <code>Bundles -&gt; Bundle Editor</code></li>
<li>左边栏选择 <code>Input field</code> (Show) -&gt; <code>Format</code> (Show) -&gt; <code>Format SQL</code> (Show)</li>
<li>在 “Command” 区域找到这行代码 <code>&lt;input type=&quot;hidden&quot; name=&quot;clientid&quot; value=&quot;...&quot; /&gt;</code></li>
<li>把这个 <code>input</code> 的 <code>value</code> 改为 <code>dpriver-9094-8133-2031</code></li>
<li>保存</li>
</ul>
<p>这样修改后 SQL 格式化应该可以正常工作。</p>
<div class="tip"><br>可以发现 Sequel Pro 提供的 SQL 格式化功能是以调用远程接口服务来实现的，并不是客户端内置的原生功能，使用时也需要联网。<br></div>

<h2 id="自己动手"><a href="#自己动手" class="headerlink" title="自己动手"></a>自己动手</h2><p>自带的 Bundle 修正之后基本功能没问题，但执行的时候不仅会弹出个调用远程接口的对话框，而且 SQL 的格式也不太令人满意。</p>
<p>除了 Sequel Pro 提供的 Bundle 所使用的 SQL格式化的服务外，还有其他类似的服务同样提供了可随意调用的 API，比如 <a href="https://sqlformat.org/" target="_blank" rel="external">https://sqlformat.org/</a>。</p>
<p>这里就以 <a href="https://sqlformat.org/" target="_blank" rel="external">sqlformat.org</a> 为例介绍一下如何创建一个比官方更好用的自定义 SQL 格式化 Bundle。</p>
<h3 id="打开-Bundle-编辑器"><a href="#打开-Bundle-编辑器" class="headerlink" title="打开 Bundle 编辑器"></a>打开 Bundle 编辑器</h3><p>按菜单 <code>Bundles</code> -&gt; <code>Bundle Editor</code> 打开编辑器</p>
<img src="/2017/04/14/Sequel-Pro-SQL-Formatter/14926890939691.jpg" alt="14926890939691.jpg" title="">
<h3 id="创建-Bundle"><a href="#创建-Bundle" class="headerlink" title="创建 Bundle"></a>创建 Bundle</h3><p>将侧边菜单展开到 <code>Input Field</code> -&gt; <code>Format</code> -&gt; <code>Format SQL</code>，右键创建一个副本。</p>
<img src="/2017/04/14/Sequel-Pro-SQL-Formatter/14926892176026.jpg" alt="14926892176026.jpg" title="">
<h3 id="配置-Bundle"><a href="#配置-Bundle" class="headerlink" title="配置 Bundle"></a>配置 Bundle</h3><img src="/2017/04/14/Sequel-Pro-SQL-Formatter/14926894425970.jpg" alt="14926894425970.jpg" title="">
<p>注意将 <code>OutPut</code> 项更改为 <code>Replace Selection</code>，然后在 <code>Command</code> 部分贴入以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"><span class="keyword">import</span> urllib2, urllib</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> sys</div><div class="line">reload(sys)</div><div class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</div><div class="line">sql = sys.stdin.read()</div><div class="line">params = &#123;<span class="string">'sql'</span>: sql, <span class="string">'reindent'</span>: <span class="number">1</span>, <span class="string">'keyword_case'</span>: <span class="string">'upper'</span>, <span class="string">'identifier_case'</span>: <span class="string">'lower'</span>&#125;</div><div class="line">response = urllib2.urlopen(<span class="string">'https://sqlformat.org/api/v1/format'</span>, data=urllib.urlencode(params))</div><div class="line">data = json.loads(response.read())</div><div class="line"><span class="keyword">print</span> data[<span class="string">'result'</span>]</div></pre></td></tr></table></figure>
<p>代码的功能就是调用了 <a href="https://sqlformat.org/" target="_blank" rel="external">https://sqlformat.org/</a> 的 API 并用格式化后的结果替换掉所选择的 SQL，代码贴完后 <code>Save</code>，从菜单里启用或者设置个快捷键看看效果吧。</p>
<p>这样一条 SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">TYPE</span>, <span class="keyword">sum</span>(<span class="keyword">CASE</span> vender <span class="keyword">WHEN</span> <span class="string">'A'</span> <span class="keyword">THEN</span> pcs <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>), <span class="keyword">sum</span>(<span class="keyword">CASE</span> vender <span class="keyword">WHEN</span> <span class="string">'C'</span> <span class="keyword">THEN</span> pcs <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>), <span class="keyword">sum</span>(<span class="keyword">CASE</span> vender <span class="keyword">WHEN</span> <span class="string">'B'</span> <span class="keyword">THEN</span> pcs <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>) <span class="keyword">FROM</span> tablename t <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t1 <span class="keyword">ON</span> t1.id = t.id <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> t2.id = t.id <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="string">`type`</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> t.create_time <span class="keyword">DESC</span> <span class="keyword">HAVING</span> t.cnt &gt; <span class="number">2</span></div></pre></td></tr></table></figure>
<p>格式化之后：</p>
<img src="/2017/04/14/Sequel-Pro-SQL-Formatter/14926907232365.jpg" alt="14926907232365.jpg" title="">
<p><a href="https://sqlformat.org/" target="_blank" rel="external">sqlformat.org</a> 的 API 文档里还有一些可选项可以设置，比如是否大写关键字、缩进宽度、是否移除注释等，可以参考文档修改代码参数。</p>
<ul>
<li><a href="https://sqlformat.org/api/" target="_blank" rel="external">https://sqlformat.org/api/</a></li>
</ul>
<p>附 PHP 版代码，效果一致：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/php</span></div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$sql = @file_get_contents(<span class="string">"php://stdin"</span>);</div><div class="line"></div><div class="line">$req = [</div><div class="line">	<span class="string">'reindent'</span> =&gt; <span class="number">1</span>,</div><div class="line">	<span class="string">'sql'</span> =&gt; $sql,</div><div class="line">	<span class="string">'keyword_case'</span> =&gt; <span class="string">'upper'</span>,</div><div class="line">	<span class="string">'identifier_case'</span> =&gt; <span class="string">'lower'</span>,</div><div class="line">];</div><div class="line"></div><div class="line">$ch = curl_init();</div><div class="line">curl_setopt($ch, CURLOPT_URL, <span class="string">'https://sqlformat.org/api/v1/format'</span>);</div><div class="line">curl_setopt($ch, CURLOPT_POST, count($req));</div><div class="line">curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($req));</div><div class="line">curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</div><div class="line">$ret = curl_exec($ch);</div><div class="line">curl_close($ch);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> json_decode($ret, <span class="keyword">true</span>)[<span class="string">'result'</span>];</div></pre></td></tr></table></figure>
<p>懒得折腾，下载打包好的 Bundle 直接导入即可：</p>
<blockquote>
<p><a href="http://newt0n.github.io/2017/04/14/Sequel-Pro-SQL-Formatter/Format-SQL-Py.spBundle.zip" target="_blank" rel="external">http://newt0n.github.io/2017/04/14/Sequel-Pro-SQL-Formatter/Format-SQL-Py.spBundle.zip</a></p>
</blockquote>
<div class="post-qrcode"><div class="qrcode-desc">关注 <strong class="em">NewtonIO</strong> - 创造者们的技术与工具</div><img src="/img/wechat-mp.jpg" title="Wechat" class="qrcode-img"></div><div class="copyright"><blockquote><strong>本文链接: </strong><a href="http://newton.sh/2017/04/14/Sequel-Pro-SQL-Formatter/index.html">http://newton.sh/2017/04/14/Sequel-Pro-SQL-Formatter/index.html</a><div><strong>版权声明: </strong>所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">CC BY-NC-SA 3.0 CN 许可协议 </a>进行许可，转载请注明出处。</div></blockquote></div></div><div class="post-reward"><input type="checkbox" name="reward" id="reward" hidden=""><label for="reward" class="reward-button">赞赏</label><div class="reward-text">一点鼓励</div><div class="qr-code"><label for="reward" class="qr-code-image"><img src="/img/wechat.png" title="Wechat" class="image"></label><label for="reward" class="qr-code-image"><img src="/img/alipay.png" title="Alipay" class="image"></label></div></div></article></div></main><footer><div class="paginator"><a href="/2017/04/06/Go-Range-内部实现/" class="next">NEXT</a></div><div data-thread-key="2017/04/14/Sequel-Pro-SQL-Formatter/" data-title="Sequel Pro 实现更好的 SQL 格式化" data-url="http://newton.sh/2017/04/14/Sequel-Pro-SQL-Formatter/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"newt0n"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://newton.sh">Newton</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>window._pt_lt = new Date().getTime();
window._pt_sp_2 = [];
window._pt_sp_2.push('setAccount,51b5fda6');
var _protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
(function() {
    var atag = document.createElement('script'); atag.type = 'text/javascript'; atag.async = true;
    atag.src = _protocol + 'js.ptengine.cn/51b5fda6.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(atag, s);
})();</script></body></html>